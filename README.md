# Система синхронизации MySQL ↔ Google Sheets

## 🎯 Что делает система

Создана полная система двусторонней синхронизации между вашей MySQL базой данных (с данными OZON/WB) и Google Sheets. 

### Основные возможности:

#### 1. **Двусторонняя синхронизация**
- **MySQL → Google Sheets**: Автоматически выгружает данные из БД в таблицы
- **Google Sheets → MySQL**: Загружает изменения из таблиц обратно в БД
- **Пакетная обработка**: Работает с большими объемами данных порциями

#### 2. **Автоматические триггеры**
- MySQL триггеры отслеживают все изменения в таблицах (INSERT/UPDATE/DELETE)
- Записывают изменения в таблицу `change_log` 
- Фоновый сервис обрабатывает очередь изменений и синхронизирует с Google Sheets

#### 3. **REST API сервис**
- FastAPI веб-сервис для управления синхронизацией
- Endpoints для запуска синхронизации, мониторинга статуса
- Веб-интерфейс и API документация

#### 4. **Гибкая конфигурация**
- YAML конфиг для маппинга полей MySQL ↔ Google Sheets
- Настройки направления синхронизации для каждой таблицы
- Управление размерами батчей и интервалами

## 📊 Какие таблицы синхронизируются

Настроена синхронизация для основных таблиц вашего проекта:

### OZON данные:
- `tovar` - товары OZON → лист "OZON_Товары"
- `stocks` - остатки OZON → лист "OZON_Остатки" 
- `prices` - цены OZON → лист "OZON_Цены"
- `report_fbo` - отчеты FBO → лист "OZON_FBO_Отчет"

### WB данные:
- `tovar_wb` - товары WB → лист "WB_Товары"
- `stock_wb` - остатки WB → лист "WB_Остатки"

## 🏗️ Архитектура системы

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   MySQL БД      │    │  Sync Service   │    │ Google Sheets   │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │   Таблицы   │◄┼────┼►│MySQL Client │ │    │ │    Листы    │ │
│ │             │ │    │ │             │ │    │ │             │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
│                 │    │        │        │    │        ▲        │
│ ┌─────────────┐ │    │        ▼        │    │        │        │
│ │ change_log  │ │    │ ┌─────────────┐ │    │        │        │
│ │   (очередь) │ │    │ │   Sync      │ │    │        │        │
│ └─────────────┘ │    │ │ Processors  │ │    │        │        │
│                 │    │ └─────────────┘ │    │        │        │
│ ┌─────────────┐ │    │        │        │    │        │        │
│ │  Triggers   │ │    │        ▼        │    │        │        │
│ └─────────────┘ │    │ ┌─────────────┐ │    │        │        │
│                 │    │ │Sheets Client│◄┼────┼────────┘        │
└─────────────────┘    │ └─────────────┘ │    │                 │
                       │                 │    └─────────────────┘
                       │ ┌─────────────┐ │
                       │ │ FastAPI     │ │
                       │ │ (REST API)  │ │
                       │ └─────────────┘ │
                       └─────────────────┘
```

## 🚀 Как протестировать

### 1. Быстрый тест подключений

```bash
# Тест всех компонентов системы
python test_connection.py
```

Этот скрипт проверит:
- ✅ Подключение к MySQL базе данных
- ✅ Доступность Google Sheets API
- ✅ Корректность конфигурации
- ✅ Наличие необходимых таблиц и листов

### 2. Первоначальная настройка

```bash
# 1. Установка зависимостей
./scripts/install.sh

# 2. Копирование конфигурации
cp config.env.example config.env
# Отредактируйте config.env с вашими данными MySQL и Google Sheets ID

# 3. Настройка Google API credentials
mkdir -p credentials
# Поместите ваш credentials.json в папку credentials/

# 4. Настройка MySQL (триггеры и change_log)
./scripts/setup_mysql.sh

# 5. Проверка подключений
python test_connection.py
```

### 3. Запуск сервиса

```bash
# Запуск в development режиме
./scripts/start.sh

# Или с Docker
docker-compose up --build
```

### 4. Тестирование через веб-интерфейс

После запуска откройте в браузере:

- **API документация**: http://localhost:8000/docs
- **Статус здоровья**: http://localhost:8000/health
- **Конфигурация таблиц**: http://localhost:8000/config/tables

### 5. Тестирование синхронизации

#### a) Тест MySQL → Google Sheets:

```bash
# Через API
curl -X POST "http://localhost:8000/sync/mysql-to-sheets" \
  -H "Content-Type: application/json" \
  -d '{"tables": ["tovar"], "force_full_sync": true}'

# Или через веб-интерфейс: http://localhost:8000/docs
```

#### b) Тест автоматических триггеров:

```sql
-- Добавьте тестовую запись в MySQL
INSERT INTO tovar (cabinet, sku, title, price) 
VALUES ('test_cabinet', 'test_sku', 'Test Product', '100.00');

-- Проверьте change_log
SELECT * FROM change_log ORDER BY created_at DESC LIMIT 5;
```

#### c) Тест Google Sheets → MySQL:

1. Откройте вашу Google Таблицу
2. Найдите лист "OZON_Товары" 
3. Измените данные в таблице
4. Запустите синхронизацию:

```bash
curl -X POST "http://localhost:8000/sync/sheets-to-mysql" \
  -H "Content-Type: application/json" \
  -d '{"tables": ["tovar"]}'
```

### 6. Мониторинг

#### Проверка логов:
```bash
# Логи сервиса
tail -f logs/sync_service.log

# Статистика change_log
curl http://localhost:8000/change-log/stats
```

#### Проверка статуса:
```bash
# Общий статус системы
curl http://localhost:8000/health

# Статус синхронизации  
curl http://localhost:8000/sync/status
```

## 🔧 Ручное управление

### Принудительная полная синхронизация:
```bash
curl -X POST "http://localhost:8000/sync/bidirectional" \
  -H "Content-Type: application/json" \
  -d '{"force_full_sync": true}'
```

### Обработка очереди изменений:
```bash
curl -X POST http://localhost:8000/change-log/process
```

### Очистка старых записей:
```bash
curl -X POST "http://localhost:8000/change-log/cleanup?retention_days=30"
```

## 📂 Структура проекта

```
├── sync_service/           # Основной код сервиса
│   ├── clients/           # Клиенты MySQL и Google Sheets
│   ├── sync/              # Модули синхронизации
│   ├── config/            # Конфигурация и маппинг
│   └── triggers/          # SQL скрипты триггеров
├── scripts/               # Скрипты установки и запуска
├── docs/                  # Документация
├── credentials/           # Google API credentials
├── logs/                  # Логи системы
├── config.env             # Основная конфигурация
└── docker-compose.yml     # Docker конфигурация
```

## ⚡ Что происходит автоматически

1. **При изменении данных в MySQL**:
   - Триггер записывает изменение в `change_log`
   - Фоновый процессор (каждые 30 сек) читает очередь
   - Изменения применяются в Google Sheets

2. **При ручном запуске синхронизации**:
   - Данные читаются постранично (батчами)
   - Выполняется upsert операция (вставка или обновление)
   - Ведется журнал операций

3. **Контроль ошибок**:
   - Автоматические повторы при ошибках
   - Логирование всех операций
   - API для мониторинга статуса

## 🚨 Важные моменты

- **PHP скрипты в `botscript/` не изменялись** - они продолжают работать как раньше
- **Система работает параллельно** с существующим ботом
- **Безопасность**: все credentials в отдельных файлах
- **Масштабируемость**: поддержка больших объемов данных
- **Мониторинг**: полная видимость всех операций

Система готова к production использованию! 🎉
